<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amazon Web Services &mdash; Nextflow 23.10.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Amazon S3 storage" href="amazons3.html" />
    <link rel="prev" title="Wave containers" href="wave.html" />
     
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TNCXSWG');</script>
    <!-- End Google Tag Manager -->

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html">
            <img src="_static/nextflow-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div>
    <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getstarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html">Basic concepts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="script.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="process.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="channel.html">Channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="operator.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="module.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="dsl1.html">Migrating from DSL 1</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Execution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command line interface (CLI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="executor.html">Executors</a></li>
<li class="toctree-l1"><a class="reference internal" href="cache-and-resume.html">Caching and resuming</a></li>
<li class="toctree-l1"><a class="reference internal" href="tracing.html">Tracing &amp; visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="sharing.html">Pipeline sharing</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Workflow introspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="mail.html">Mail &amp; Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="secrets.html">Secrets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software dependencies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="container.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="conda.html">Conda environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="spack.html">Spack environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="wave.html">Wave containers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Compute &amp; storage platforms</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Amazon Web Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#aws-security-credentials">AWS security credentials</a></li>
<li class="toctree-l2"><a class="reference internal" href="#aws-iam-policies">AWS IAM policies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#s3-policies">S3 policies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#aws-batch">AWS Batch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#aws-cli">AWS CLI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-started">Get started</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#container-options">Container Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-ami">Custom AMI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-your-custom-ami">Create your custom AMI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aws-cli-installation">AWS CLI installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-installation">Docker installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#amazon-ecs-container-agent-installation">Amazon ECS container agent installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#jobs-execution">Jobs &amp; Execution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-job-definition">Custom job definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pipeline-execution">Pipeline execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hybrid-workloads">Hybrid workloads</a></li>
<li class="toctree-l3"><a class="reference internal" href="#volume-mounts">Volume mounts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-configuration">Advanced configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="amazons3.html">Amazon S3 storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="azure.html">Azure Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="fusion.html">Fusion file system</a></li>
<li class="toctree-l1"><a class="reference internal" href="google.html">Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional integrations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="flux.html">Flux Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="ignite.html">Apache Ignite</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developer/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer/packages.html">Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer/plugins.html">Core plugins</a></li>
</ul>

        </div>
    <div class="nav-footer-logo">
        <a href="https://seqera.io/" target="_blank" title="Developed by Seqera Labs">
            Nextflow is developed by:<br>
            <img src="_static/seqera-logo.svg" alt="Seqera Labs">
        </a>
    </div>

      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Nextflow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Amazon Web Services</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/nextflow-io/nextflow/blob/master/docs/aws.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="amazon-web-services">
<span id="aws-page"></span><h1>Amazon Web Services<a class="headerlink" href="#amazon-web-services" title="Permalink to this heading"></a></h1>
<section id="aws-security-credentials">
<h2>AWS security credentials<a class="headerlink" href="#aws-security-credentials" title="Permalink to this heading"></a></h2>
<p>Nextflow uses the <a class="reference external" href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html">AWS security credentials</a> to make programmatic calls to AWS services.</p>
<p>The AWS credentials are selected from the following sources, in order of descending priority:</p>
<ol class="arabic">
<li><p>Nextflow configuration file - <code class="docutils literal notranslate"><span class="pre">aws.accessKey</span></code> and <code class="docutils literal notranslate"><span class="pre">aws.secretKey</span></code>. See <a class="reference internal" href="config.html#config-aws"><span class="std std-ref">AWS configuration</span></a> for more details.</p></li>
<li><p>A custom profile in <code class="docutils literal notranslate"><span class="pre">$HOME/.aws/credentials</span></code> and/or <code class="docutils literal notranslate"><span class="pre">$HOME/.aws/config</span></code>. The profile can be supplied from the <code class="docutils literal notranslate"><span class="pre">aws.profile</span></code> config option, or the <code class="docutils literal notranslate"><span class="pre">AWS_PROFILE</span></code> or <code class="docutils literal notranslate"><span class="pre">AWS_DEFAULT_PROFILE</span></code> environmental variables.</p></li>
<li><p>Environment variables - <code class="docutils literal notranslate"><span class="pre">AWS_ACCESS_KEY_ID</span></code> and <code class="docutils literal notranslate"><span class="pre">AWS_SECRET_ACCESS_KEY</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">default</span></code> profile in <code class="docutils literal notranslate"><span class="pre">~/.aws/credentials</span></code> and/or <code class="docutils literal notranslate"><span class="pre">~/.aws/config</span></code>.</p></li>
<li><p>Single Sign-On (SSO) credentials. See the <a class="reference external" href="https://docs.aws.amazon.com/cli/latest/userguide/sso-configure-profile-token.html">AWS documentation</a> for more details.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 23.07.0-edge.</span></p>
</div>
</li>
<li><p>EC2 instance profile credentials. See the <a class="reference external" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html">AWS documentation</a> and <a class="reference external" href="https://aws.amazon.com/blogs/security/granting-permission-to-launch-ec2-instances-with-iam-roles-passrole-permission/">this blog post</a> for more details.</p></li>
</ol>
<p>The AWS region is selected from the following sources, in order of descending priority:</p>
<ol class="arabic simple">
<li><p>Nextflow configuration file - <code class="docutils literal notranslate"><span class="pre">aws.region</span></code></p></li>
<li><p>Environment variables - <code class="docutils literal notranslate"><span class="pre">AWS_REGION</span></code> or <code class="docutils literal notranslate"><span class="pre">AWS_DEFAULT_REGION</span></code></p></li>
<li><p>EC2 instance metadata (if Nextflow is running in an EC2 instance)</p></li>
</ol>
<p>SSO credentials and instance profile credentials are the most recommended because they don’t require you to manage and distribute AWS keys explicitly. SSO credentials are ideal for launching pipelines from outside of AWS (e.g. your laptop), while instance profile credentials are ideal for launching pipelines within AWS (e.g. an EC2 instance).</p>
</section>
<section id="aws-iam-policies">
<h2>AWS IAM policies<a class="headerlink" href="#aws-iam-policies" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html">IAM policies</a> are the mechanism used by AWS to defines permissions for IAM identities. In order to access certain AWS services, the proper policies must be attached to the identity associated to the AWS credentials.</p>
<p>Minimal permissions policies to be attached to the AWS account used by Nextflow are:</p>
<ul>
<li><p>To use AWS Batch:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;batch:DescribeJobQueues&quot;</span>
<span class="s2">&quot;batch:CancelJob&quot;</span>
<span class="s2">&quot;batch:SubmitJob&quot;</span>
<span class="s2">&quot;batch:ListJobs&quot;</span>
<span class="s2">&quot;batch:DescribeComputeEnvironments&quot;</span>
<span class="s2">&quot;batch:TerminateJob&quot;</span>
<span class="s2">&quot;batch:DescribeJobs&quot;</span>
<span class="s2">&quot;batch:RegisterJobDefinition&quot;</span>
<span class="s2">&quot;batch:DescribeJobDefinitions&quot;</span>
</pre></div>
</div>
</li>
<li><p>To view <a class="reference external" href="https://aws.amazon.com/ec2/">EC2</a> instances:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;ecs:DescribeTasks&quot;</span>
<span class="s2">&quot;ec2:DescribeInstances&quot;</span>
<span class="s2">&quot;ec2:DescribeInstanceTypes&quot;</span>
<span class="s2">&quot;ec2:DescribeInstanceAttribute&quot;</span>
<span class="s2">&quot;ecs:DescribeContainerInstances&quot;</span>
<span class="s2">&quot;ec2:DescribeInstanceStatus&quot;</span>
</pre></div>
</div>
</li>
<li><p>To pull container images from <a class="reference external" href="https://aws.amazon.com/ecr/">ECR</a> repositories:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;ecr:GetAuthorizationToken&quot;</span>
<span class="s2">&quot;ecr:BatchCheckLayerAvailability&quot;</span>
<span class="s2">&quot;ecr:GetDownloadUrlForLayer&quot;</span>
<span class="s2">&quot;ecr:GetRepositoryPolicy&quot;</span>
<span class="s2">&quot;ecr:DescribeRepositories&quot;</span>
<span class="s2">&quot;ecr:ListImages&quot;</span>
<span class="s2">&quot;ecr:DescribeImages&quot;</span>
<span class="s2">&quot;ecr:BatchGetImage&quot;</span>
<span class="s2">&quot;ecr:GetLifecyclePolicy&quot;</span>
<span class="s2">&quot;ecr:GetLifecyclePolicyPreview&quot;</span>
<span class="s2">&quot;ecr:ListTagsForResource&quot;</span>
<span class="s2">&quot;ecr:DescribeImageScanFindings&quot;</span>
</pre></div>
</div>
</li>
</ul>
<section id="s3-policies">
<h3>S3 policies<a class="headerlink" href="#s3-policies" title="Permalink to this heading"></a></h3>
<p>Nextflow also requires policies to access <a class="reference external" href="https://aws.amazon.com/s3/">S3 buckets</a> in order to use the work directory, pull input data, and publish results.</p>
<p>Depending on the pipeline configuration, the above actions can be done all in a single bucket but, more likely, spread across multiple buckets. Once the list of buckets used by the pipeline is identified, there are two alternative ways to give Nextflow access to these buckets:</p>
<ol class="arabic">
<li><p>Grant access to all buckets by attaching the policy <code class="docutils literal notranslate"><span class="pre">&quot;s3:*&quot;</span></code> to the IAM identity. This works only if buckets do not set their own access policies (see point 2);</p></li>
<li><p>For more fine grained control, assign to each bucket the following policy (replace the placeholders with the actual values):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;my policy id&gt;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;my statement id&gt;&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Principal&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;AWS&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;ARN of the nextflow identity&gt;&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;s3:PutObject&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;s3:DeleteObject&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:s3:::&lt;bucket name&gt;/*&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AllowSSLRequestsOnly&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Deny&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Principal&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s3:*&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;arn:aws:s3:::&lt;bucket name&gt;&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;arn:aws:s3:::&lt;bucket name&gt;/*&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;Condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;Bool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;aws:SecureTransport&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
<p>See the <a class="reference external" href="https://docs.aws.amazon.com/config/latest/developerguide/s3-bucket-policy.html">bucket policy documentation</a> for additional details.</p>
</section>
</section>
<section id="aws-batch">
<span id="id1"></span><h2>AWS Batch<a class="headerlink" href="#aws-batch" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://aws.amazon.com/batch/">AWS Batch</a> is a managed computing service that allows the execution of containerised workloads in the Amazon cloud infrastructure. It dynamically provisions the optimal quantity and type of compute resources (e.g., CPU or memory optimized compute resources) based on the volume and specific resource requirements of the jobs submitted.</p>
<p>Nextflow provides built-in support for AWS Batch, allowing the seamless deployment of Nextflow pipelines in the cloud, in which tasks are offloaded as Batch jobs.</p>
<p>Read the <a class="reference internal" href="executor.html#awsbatch-executor"><span class="std std-ref">AWS Batch executor</span></a> section to learn more about the <code class="docutils literal notranslate"><span class="pre">awsbatch</span></code> executor in Nextflow.</p>
<section id="aws-cli">
<span id="aws-batch-config"></span><h3>AWS CLI<a class="headerlink" href="#aws-cli" title="Permalink to this heading"></a></h3>
<p>Nextflow needs the <a class="reference external" href="https://aws.amazon.com/cli/">AWS command line tool</a> (<code class="docutils literal notranslate"><span class="pre">aws</span></code>) to be available in the container in which tasks are executed, in order to stage input files and output files to and from S3 storage.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When using <a class="reference internal" href="wave.html#wave-page"><span class="std std-ref">Wave containers</span></a> and <a class="reference internal" href="fusion.html#fusion-page"><span class="std std-ref">Fusion file system</span></a>, the AWS command line tool is not needed for task containers or the underlying EC2 instances when running Nextflow on AWS Batch. See the <a class="reference internal" href="fusion.html#fusion-page"><span class="std std-ref">Fusion file system</span></a> documentation for more details.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">aws</span></code> command can be made available in the container in two ways:</p>
<ol class="arabic simple">
<li><p>Installed in the Docker image(s) used during the pipeline execution,</p></li>
<li><p>Installed in a custom <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMI (Amazon Machine Image)</a> to use in place of the default AMI when configuring AWS Batch (see next section).</p></li>
</ol>
<p>The latter approach is preferred because it allows the use of existing Docker images without having to add the AWS CLI to each one.</p>
<p>See the sections below to learn how to create a custom AMI and install the AWS CLI tool in it.</p>
</section>
<section id="get-started">
<h3>Get started<a class="headerlink" href="#get-started" title="Permalink to this heading"></a></h3>
<ol class="arabic simple">
<li><p>In the AWS Console, navigate to <strong>AWS Batch</strong> and create a <a class="reference external" href="http://docs.aws.amazon.com/batch/latest/userguide/compute_environments.html">Compute environment</a> (CE).</p>
<ol class="arabic simple">
<li><p>If you are using a custom AMI (see following sections), the AMI ID must be specified in the CE configuration</p></li>
<li><p>Make sure to select an AMI (either custom or existing) with Docker installed (see following sections)</p></li>
<li><p>Make sure the policy <code class="docutils literal notranslate"><span class="pre">AmazonS3FullAccess</span></code> (granting access to S3 buckets) is attached to the instance role configured for the CE</p></li>
<li><p>If you plan to use Docker images from Amazon ECS container, make sure the <code class="docutils literal notranslate"><span class="pre">AmazonEC2ContainerServiceforEC2Role</span></code> policy is also attached to the instance role</p></li>
</ol>
</li>
<li><p>In the AWS Console, create (at least) one <a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/job_queues.html">Job Queue</a> and bind it to the Compute environment.</p></li>
<li><p>In the AWS Console, create an S3 bucket for the work directory (see below). You can also create separate buckets for input data and results, as needed.</p></li>
<li><p>Make sure that every process in your pipeline specifies a Docker container with the <a class="reference internal" href="process.html#process-container"><span class="std std-ref">container</span></a> directive.</p></li>
<li><p>Make sure that all of your container images are published in a Docker registry that can be reached by AWS Batch, such as <a class="reference external" href="https://hub.docker.com/">Docker Hub</a>, <a class="reference external" href="https://quay.io/">Quay</a>, or <a class="reference external" href="https://aws.amazon.com/ecr/">Elastic Container Registry</a>.</p></li>
</ol>
</section>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading"></a></h3>
<p>To configure your pipeline for AWS Batch:</p>
<ol class="arabic simple">
<li><p>Specify the AWS Batch <a class="reference internal" href="executor.html#awsbatch-executor"><span class="std std-ref">executor</span></a></p></li>
<li><p>Specify one or more AWS Batch queues with the <a class="reference internal" href="process.html#process-queue"><span class="std std-ref">queue</span></a> directive</p></li>
<li><p>Specify any Batch job container options with the <a class="reference internal" href="process.html#process-containeroptions"><span class="std std-ref">containerOptions</span></a> directive.</p></li>
</ol>
<p>An example <code class="docutils literal notranslate"><span class="pre">nextflow.config</span></code> file is shown below:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">process</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;awsbatch&#39;</span>
<span class="w">    </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;my-batch-queue&#39;</span>
<span class="w">    </span><span class="n">container</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;quay.io/biocontainers/salmon&#39;</span>
<span class="w">    </span><span class="n">containerOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;--shm-size 16000000 --ulimit nofile=1280:2560 --ulimit nproc=16:32&#39;</span>
<span class="o">}</span>

<span class="n">aws</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">batch</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="c1">// NOTE: this setting is only required if the AWS CLI tool is installed in a custom AMI</span>
<span class="w">        </span><span class="n">cliPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/home/ec2-user/miniconda/bin/aws&#39;</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">    </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;us-east-1&#39;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Different queues bound to the same or different Compute Environments can be configured according to each process’ requirements.</p>
</section>
</section>
<section id="container-options">
<h2>Container Options<a class="headerlink" href="#container-options" title="Permalink to this heading"></a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 21.12.1-edge.</span></p>
</div>
<p>The <a class="reference internal" href="process.html#process-containeroptions"><span class="std std-ref">containerOptions</span></a> directive can be used to control the properties of the container execution associated with each Batch job.</p>
<p>The following container options are currently supported:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">e</span><span class="p">,</span> <span class="o">--</span><span class="n">env</span> <span class="n">string</span>
    <span class="n">Set</span> <span class="n">environment</span> <span class="n">variables</span> <span class="p">(</span><span class="nb">format</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span> <span class="ow">or</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;=&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">--</span><span class="n">init</span>
    <span class="n">Run</span> <span class="n">an</span> <span class="n">init</span> <span class="n">inside</span> <span class="n">the</span> <span class="n">container</span> <span class="n">that</span> <span class="n">forwards</span> <span class="n">signals</span> <span class="ow">and</span> <span class="n">reaps</span> <span class="n">processes</span>
<span class="o">--</span><span class="n">memory</span><span class="o">-</span><span class="n">swap</span> <span class="nb">int</span>
    <span class="n">The</span> <span class="n">total</span> <span class="n">amount</span> <span class="n">of</span> <span class="n">swap</span> <span class="n">memory</span> <span class="p">(</span><span class="ow">in</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">the</span> <span class="n">container</span> <span class="n">can</span> <span class="n">use</span><span class="p">:</span> <span class="s1">&#39;-1&#39;</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">unlimited</span> <span class="n">swap</span>
<span class="o">--</span><span class="n">memory</span><span class="o">-</span><span class="n">swappiness</span> <span class="nb">int</span>
    <span class="n">Tune</span> <span class="n">container</span> <span class="n">memory</span> <span class="n">swappiness</span> <span class="p">(</span><span class="mi">0</span> <span class="n">to</span> <span class="mi">100</span><span class="p">)</span> <span class="p">(</span><span class="n">default</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="o">--</span><span class="n">privileged</span>
    <span class="n">Give</span> <span class="n">extended</span> <span class="n">privileges</span> <span class="n">to</span> <span class="n">the</span> <span class="n">container</span>
<span class="o">--</span><span class="n">read</span><span class="o">-</span><span class="n">only</span>
    <span class="n">Mount</span> <span class="n">the</span> <span class="n">container</span><span class="s1">&#39;s root filesystem as read only</span>
<span class="o">--</span><span class="n">shm</span><span class="o">-</span><span class="n">size</span> <span class="nb">int</span>
    <span class="n">Size</span> <span class="p">(</span><span class="ow">in</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">of</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span>
<span class="o">--</span><span class="n">tmpfs</span> <span class="n">string</span>
    <span class="n">Mount</span> <span class="n">a</span> <span class="n">tmpfs</span> <span class="n">directory</span> <span class="p">(</span><span class="nb">format</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">path</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span><span class="p">,</span><span class="n">size</span><span class="o">=&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">),</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">MiB</span>
<span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">--</span><span class="n">user</span> <span class="n">string</span>
    <span class="n">Username</span> <span class="ow">or</span> <span class="n">UID</span> <span class="p">(</span><span class="nb">format</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">|</span><span class="n">uid</span><span class="o">&gt;</span><span class="p">[:</span><span class="o">&lt;</span><span class="n">group</span><span class="o">|</span><span class="n">gid</span><span class="o">&gt;</span><span class="p">])</span>
<span class="o">--</span><span class="n">ulimit</span> <span class="n">string</span>
    <span class="n">Ulimit</span> <span class="n">options</span> <span class="p">(</span><span class="nb">format</span><span class="p">:</span> <span class="o">&lt;</span><span class="nb">type</span><span class="o">&gt;=&lt;</span><span class="n">soft</span> <span class="n">limit</span><span class="o">&gt;</span><span class="p">[:</span><span class="o">&lt;</span><span class="n">hard</span> <span class="n">limit</span><span class="o">&gt;</span><span class="p">])</span>
</pre></div>
</div>
<p>Container options may be passed in long form (e.g <code class="docutils literal notranslate"><span class="pre">--option</span> <span class="pre">value</span></code>) or short form (e.g. <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">value</span></code>) where available.</p>
<p>Few examples:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">containerOptions</span><span class="w"> </span><span class="s1">&#39;--tmpfs /run:rw,noexec,nosuid,size=128 --tmpfs /app:ro,size=64&#39;</span>

<span class="n">containerOptions</span><span class="w"> </span><span class="s1">&#39;-e MYVAR1 --env MYVAR2=foo2 --env MYVAR3=foo3 --memory-swap 3240000 --memory-swappiness 20 --shm-size 16000000&#39;</span>

<span class="n">containerOptions</span><span class="w"> </span><span class="s1">&#39;--ulimit nofile=1280:2560 --ulimit nproc=16:32 --privileged&#39;</span>
</pre></div>
</div>
<p>Check the <a class="reference external" href="https://docs.aws.amazon.com/batch/latest/APIReference/API_ContainerProperties.html">AWS documentation</a> for further details.</p>
</section>
<section id="custom-ami">
<h2>Custom AMI<a class="headerlink" href="#custom-ami" title="Permalink to this heading"></a></h2>
<p>There are several reasons why you might need to create your own <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMI (Amazon Machine Image)</a> to use in your Compute Environments:</p>
<ul class="simple">
<li><p>You do not want to install the AWS CLI into each of your Docker images and would rather provide it through the AMI</p></li>
<li><p>The existing AMI (selected from the marketplace) does not have Docker installed</p></li>
<li><p>You need to attach more storage to your EC2 instance (the default ECS instance AMI has only a 30GB EBS volume which is not enough for most data pipelines)</p></li>
<li><p>You need to install additional software that is not available in your Docker image</p></li>
</ul>
<section id="create-your-custom-ami">
<h3>Create your custom AMI<a class="headerlink" href="#create-your-custom-ami" title="Permalink to this heading"></a></h3>
<p>From the EC2 Dashboard, select <strong>Launch Instance</strong>, then select <strong>Browse more AMIs</strong>. In the new page, select
<strong>AWS Marketplace AMIs</strong>, and then search for <strong>Amazon ECS-Optimized Amazon Linux 2 (AL2) x86_64 AMI</strong>. Select the AMI and continue as usual to configure and launch the instance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The selected instance has a root volume of 30GB. Make sure to increase its size or add a second EBS volume with enough storage for real genomic workloads.</p>
</div>
<p>When the instance is running, SSH into it (or connect with the Session Manager service), install the AWS CLI, and install any other tool that may be required (see following sections).</p>
<p>Finally, select <strong>Create Image</strong> from the EC2 Dashboard to create a new AMI from the running instance (you can also do it through the AWS CLI).</p>
<p>The new AMI ID needs to be specified when creating the Batch Compute Environment.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Any additional software must be installed on the EC2 instance <em>before</em> creating the AMI.</p>
</div>
</section>
<section id="aws-cli-installation">
<span id="id2"></span><h3>AWS CLI installation<a class="headerlink" href="#aws-cli-installation" title="Permalink to this heading"></a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When using <a class="reference internal" href="wave.html#wave-page"><span class="std std-ref">Wave containers</span></a> and <a class="reference internal" href="fusion.html#fusion-page"><span class="std std-ref">Fusion file system</span></a>, the AWS command line tool is not needed for task containers or the underlying EC2 instances when running Nextflow on AWS Batch. See the <a class="reference internal" href="fusion.html#fusion-page"><span class="std std-ref">Fusion file system</span></a> documentation for more details.</p>
</div>
<p>The <a class="reference external" href="https://aws.amazon.com/cli">AWS CLI tool</a> should be installed in your custom AMI using a self-contained package manager such as <a class="reference external" href="https://conda.io">Conda</a>. That way, you can control which version of Python is used by the AWS CLI (which is written in Python).</p>
<p>If you don’t use Conda, the <code class="docutils literal notranslate"><span class="pre">aws</span></code> command will attempt to use the version of Python that is installed in the container, and it won’t be able to find the necessary dependencies.</p>
<p>The following snippet shows how to install AWS CLI with <a class="reference external" href="https://conda.io/miniconda.html">Miniconda</a> in the home folder:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span><span class="nv">$HOME</span>
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>bzip2<span class="w"> </span>wget
wget<span class="w"> </span>https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash<span class="w"> </span>Miniconda3-latest-Linux-x86_64.sh<span class="w"> </span>-b<span class="w"> </span>-f<span class="w"> </span>-p<span class="w"> </span><span class="nv">$HOME</span>/miniconda
<span class="nv">$HOME</span>/miniconda/bin/conda<span class="w"> </span>install<span class="w"> </span>-c<span class="w"> </span>conda-forge<span class="w"> </span>-y<span class="w"> </span>awscli
rm<span class="w"> </span>Miniconda3-latest-Linux-x86_64.sh
</pre></div>
</div>
<p>Afterwards, verify that the AWS CLI package works correctly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./miniconda/bin/aws<span class="w"> </span>--version
<span class="go">aws-cli/1.29.20 Python/3.11.4 Linux/4.14.318-241.531.amzn2.x86_64 botocore/1.31.20</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">aws</span></code> tool will be placed in a directory named <code class="docutils literal notranslate"><span class="pre">bin</span></code> in the main installation folder. Modifying this directory structure after the tool is installed will cause it to not work properly.</p>
</div>
<p>To configure Nextflow to use this installation, specify the <code class="docutils literal notranslate"><span class="pre">aws.batch.cliPath</span></code> option in the Nextflow configuration as shown below:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">aws</span><span class="o">.</span><span class="na">batch</span><span class="o">.</span><span class="na">cliPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/home/ec2-user/miniconda/bin/aws&#39;</span>
</pre></div>
</div>
<p>Replace the path above with the one matching the location where the <code class="docutils literal notranslate"><span class="pre">aws</span></code> tool is installed in your AMI.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 19.07.0: </span>The <code class="docutils literal notranslate"><span class="pre">executor.awscli</span></code> config option was replaced by <code class="docutils literal notranslate"><span class="pre">aws.batch.cliPath</span></code>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The grandparent directory of the <code class="docutils literal notranslate"><span class="pre">aws</span></code> tool will be mounted into the container at the same path as the host, e.g. <code class="docutils literal notranslate"><span class="pre">/home/ec2-user/miniconda</span></code>, which will shadow existing files in the container. Make sure you use a path that is not already present in the container.</p>
</div>
</section>
<section id="docker-installation">
<h3>Docker installation<a class="headerlink" href="#docker-installation" title="Permalink to this heading"></a></h3>
<p>Docker is required by Nextflow to execute tasks on AWS Batch. The <strong>Amazon ECS-Optimized Amazon Linux 2 (AL2) x86_64 AMI</strong> has Docker installed, however, if you create your AMI from a different AMI that does not have Docker installed, you will need to install it manually.</p>
<p>The following snippet shows how to install Docker on an Amazon EC2 instance:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># install Docker</span>
sudo<span class="w"> </span>yum<span class="w"> </span>update<span class="w"> </span>-y
sudo<span class="w"> </span>amazon-linux-extras<span class="w"> </span>install<span class="w"> </span>docker
sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>docker

<span class="c1"># start the Docker service</span>
sudo<span class="w"> </span>service<span class="w"> </span>docker<span class="w"> </span>start

<span class="c1"># empower your user to run Docker without sudo</span>
sudo<span class="w"> </span>usermod<span class="w"> </span>-a<span class="w"> </span>-G<span class="w"> </span>docker<span class="w"> </span>ec2-user
</pre></div>
</div>
<p>You may have to reboot your instance for the changes to <code class="docutils literal notranslate"><span class="pre">ec2-user</span></code> to take effect.</p>
<p>These steps must be done <em>before</em> creating the AMI from the current EC2 instance.</p>
</section>
<section id="amazon-ecs-container-agent-installation">
<h3>Amazon ECS container agent installation<a class="headerlink" href="#amazon-ecs-container-agent-installation" title="Permalink to this heading"></a></h3>
<p>The <a class="reference external" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_agent.html">ECS container agent</a> is a component of Amazon Elastic Container Service (Amazon ECS) and is responsible for managing containers on behalf of ECS. AWS Batch uses ECS to execute containerized jobs, therefore it requires the agent to be installed on EC2 instances within your Compute Environments.</p>
<p>The ECS agent is included in the <strong>Amazon ECS-Optimized Amazon Linux 2 (AL2) x86_64 AMI</strong> . If you use a different base AMI, you can also install the agent on any EC2 instance that supports the Amazon ECS specification.</p>
<p>To install the agent, follow these steps:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>amazon-linux-extras<span class="w"> </span>disable<span class="w"> </span>docker
sudo<span class="w"> </span>amazon-linux-extras<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>ecs
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>ecs
</pre></div>
</div>
<p>To test the installation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-s<span class="w"> </span>http://localhost:51678/v1/metadata<span class="w"> </span><span class="p">|</span><span class="w"> </span>python<span class="w"> </span>-mjson.tool<span class="w"> </span><span class="o">(</span><span class="nb">test</span><span class="o">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AmazonEC2ContainerServiceforEC2Role</span></code> policy must be attached to the instance role in order to be able to connect the EC2 instance created by the Compute Environment to the ECS container.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AmazonEC2ContainerRegistryReadOnly</span></code> policy should be attached to the instance role in order to get read-only access to Amazon EC2 Container Registry repositories.</p>
</div>
</section>
</section>
<section id="jobs-execution">
<h2>Jobs &amp; Execution<a class="headerlink" href="#jobs-execution" title="Permalink to this heading"></a></h2>
<section id="custom-job-definition">
<h3>Custom job definition<a class="headerlink" href="#custom-job-definition" title="Permalink to this heading"></a></h3>
<p>Nextflow automatically creates the Batch <a class="reference external" href="http://docs.aws.amazon.com/batch/latest/userguide/job_definitions.html">Job definitions</a> needed to execute tasks in your pipeline, so you don’t need to define them beforehand.</p>
<p>However, sometimes you may still need to specify a custom <strong>Job Definition</strong> to fine tune the configuration of a specific job, for example to define custom mount paths.</p>
<p>To do that, first create a <strong>Job Definition</strong> in the AWS Console (or by other means). Note the name of the Job definition you created. You can then associate a process execution with this Job definition by using the <a class="reference internal" href="process.html#process-container"><span class="std std-ref">container</span></a> directive and specifying, in place of the container image name, the Job definition name prefixed by <code class="docutils literal notranslate"><span class="pre">job-definition://</span></code>, as shown below:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">process</span><span class="o">.</span><span class="na">container</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;job-definition://your-job-definition-name&#39;</span>
</pre></div>
</div>
</section>
<section id="pipeline-execution">
<h3>Pipeline execution<a class="headerlink" href="#pipeline-execution" title="Permalink to this heading"></a></h3>
<p>The pipeline can be launched either in a local computer or an EC2 instance. The latter is suggested for heavy or long-running workloads.</p>
<p>Pipeline input data can be stored either locally or in an <a class="reference external" href="https://aws.amazon.com/s3/">S3</a> bucket. The pipeline execution must specify an S3 bucket to store intermediate results with the <code class="docutils literal notranslate"><span class="pre">-bucket-dir</span></code> (<code class="docutils literal notranslate"><span class="pre">-b</span></code>) command line option. For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nextflow<span class="w"> </span>run<span class="w"> </span>my-pipeline<span class="w"> </span>-bucket-dir<span class="w"> </span>s3://my-bucket/some/path
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The bucket path should include at least a top level directory name, e.g. <code class="docutils literal notranslate"><span class="pre">s3://my-bucket/work</span></code> rather than <code class="docutils literal notranslate"><span class="pre">s3://my-bucket</span></code>.</p>
</div>
</section>
<section id="hybrid-workloads">
<h3>Hybrid workloads<a class="headerlink" href="#hybrid-workloads" title="Permalink to this heading"></a></h3>
<p>Nextflow allows the use of multiple executors in the same workflow application. This feature enables the deployment of hybrid workloads in which some jobs are executed in the local computer or local computing cluster and some jobs are offloaded to AWS Batch.</p>
<p>To enable this feature, use one or more <a class="reference internal" href="config.html#config-process-selectors"><span class="std std-ref">Process selectors</span></a> in your Nextflow configuration to apply the AWS Batch <a class="reference internal" href="#aws-batch-config"><span class="std std-ref">configuration</span></a> to the subset of processes that you want to offload. For example:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">aws</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;eu-west-1&#39;</span>
<span class="w">    </span><span class="n">batch</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">cliPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/home/ec2-user/miniconda/bin/aws&#39;</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>

<span class="n">process</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nl">withLabel:</span><span class="w"> </span><span class="n">bigTask</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;awsbatch&#39;</span>
<span class="w">        </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;my-batch-queue&#39;</span>
<span class="w">        </span><span class="n">container</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;my/image:tag&#39;</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>With the above configuration, processes with the <code class="docutils literal notranslate"><span class="pre">bigTask</span></code> <a class="reference internal" href="process.html#process-label"><span class="std std-ref">label</span></a> will run on AWS Batch, while the remaining processes with run in the local computer.</p>
</section>
<section id="volume-mounts">
<h3>Volume mounts<a class="headerlink" href="#volume-mounts" title="Permalink to this heading"></a></h3>
<div class="versionadded">
<p><span class="versionmodified added">New in version 19.07.0.</span></p>
</div>
<p>User provided container volume mounts can be provided as shown below:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">aws</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;eu-west-1&#39;</span>
<span class="w">    </span><span class="n">batch</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/tmp&#39;</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Multiple volumes can be specified as a comma-separated list of paths. The usual Docker volume mount syntax can be used to specify complex volumes where the container path is different from the host path or the volume should be <em>read-only</em>. For example:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">aws</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;eu-west-1&#39;</span>
<span class="w">    </span><span class="n">batch</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;/tmp&#39;</span><span class="o">,</span><span class="w"> </span><span class="s1">&#39;/host/path:/mnt/path:ro&#39;</span><span class="o">]</span>
<span class="w">    </span><span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The above snippet defines two volume mounts for the jobs executed in your pipeline. The first volume mounts the host path <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> to the same path in the container, with the <em>read-write</em> access mode. The second volume mounts the host path <code class="docutils literal notranslate"><span class="pre">/host/path</span></code> to <code class="docutils literal notranslate"><span class="pre">/mnt/path</span></code> in the container, with the <em>read-only</em> access mode.</p>
</section>
<section id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading"></a></h3>
<p><strong>Problem</strong>: The Pipeline execution terminates with an AWS error message similar to the one shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JobQueue</span> <span class="o">&lt;</span><span class="n">your</span> <span class="n">queue</span><span class="o">&gt;</span> <span class="ow">not</span> <span class="n">found</span>
</pre></div>
</div>
<p>Make sure you have defined a AWS region in the Nextflow configuration file and it matches the region in which your Batch environment has been created.</p>
<p><strong>Problem</strong>: A process execution fails reporting the following error message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Process</span> <span class="o">&lt;</span><span class="n">your</span> <span class="n">task</span><span class="o">&gt;</span> <span class="n">terminated</span> <span class="k">for</span> <span class="n">an</span> <span class="n">unknown</span> <span class="n">reason</span> <span class="o">--</span> <span class="n">Likely</span> <span class="n">it</span> <span class="n">has</span> <span class="n">been</span> <span class="n">terminated</span> <span class="n">by</span> <span class="n">the</span> <span class="n">external</span> <span class="n">system</span>
</pre></div>
</div>
<p>This may happen when Batch is unable to execute the process script. A common cause of this problem is that the Docker container image you have specified uses a non standard <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#entrypoint">entrypoint</a> which does not allow the execution of the Bash launcher script required by Nextflow to run the job.</p>
<p>This may also happen if the AWS CLI doesn’t run correctly.</p>
<p>Other places to check for error information:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">.nextflow.log</span></code> file.</p></li>
<li><p>The Job execution log in the AWS Batch dashboard.</p></li>
<li><p>The <a class="reference external" href="https://aws.amazon.com/cloudwatch/">CloudWatch</a> logs found in the <code class="docutils literal notranslate"><span class="pre">/aws/batch/job</span></code> log group.</p></li>
</ul>
<p><strong>Problem</strong>: A process execution is stalled in the <code class="docutils literal notranslate"><span class="pre">RUNNABLE</span></code> status and the pipeline output is similar to the one below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">executor</span> <span class="o">&gt;</span>  <span class="n">awsbatch</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">process</span> <span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">your</span> <span class="n">process</span><span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">[</span>  <span class="mi">0</span><span class="o">%</span><span class="p">]</span> <span class="mi">0</span> <span class="n">of</span> <span class="o">....</span>
</pre></div>
</div>
<p>It may happen that the pipeline execution hangs indefinitely because one of the jobs is held in the queue and never gets executed. In AWS Console, the queue reports the job as <code class="docutils literal notranslate"><span class="pre">RUNNABLE</span></code> but it never moves from there.</p>
<p>There are multiple reasons why this can happen. They are mainly related to the Compute Environment workload/configuration, the docker service or container configuration, network status, etc.</p>
<p>This <a class="reference external" href="https://aws.amazon.com/premiumsupport/knowledge-center/batch-job-stuck-runnable-status/">AWS page</a> provides several resolutions and tips to investigate and work around the issue.</p>
</section>
</section>
<section id="advanced-configuration">
<h2>Advanced configuration<a class="headerlink" href="#advanced-configuration" title="Permalink to this heading"></a></h2>
<p>Read the <a class="reference internal" href="config.html#config-aws"><span class="std std-ref">AWS configuration</span></a> section to learn more about advanced configuration options.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="wave.html" class="btn btn-neutral float-left" title="Wave containers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="amazons3.html" class="btn btn-neutral float-right" title="Amazon S3 storage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Seqera Labs, S.L.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
     
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TNCXSWG"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->


</body>
</html>